<!doctype html><html dir=ltr lang=ar data-theme class=html><head><title>How to securly access AWS ECR from GitHub Actions using GitHub OIDC |
Issam Alzinati</title><meta charset=utf-8><meta name=generator content="Hugo 0.101.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Issam Alzinati"><meta name=description content="How to securly access AWS ECR from GitHub Actions using GitHub OIDC"><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=https://eelzinaty.github.io/ar/english/post/github-oidc-with-aws-orgnization/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.738c0e3a493854876aeab9e2316fd43f1936aeeac4cc6b3e60bb26456dba72ad.js integrity="sha256-c4wOOkk4VIdq6rniMW/UPxk2rurEzGs+YLsmRW26cq0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://eelzinaty.github.io/images/site-feature-image.png"><meta name=twitter:title content="How to securly access AWS ECR from GitHub Actions using GitHub OIDC"><meta name=twitter:description content="How to securly access AWS ECR from GitHub Actions using GitHub OIDC"><meta property="og:title" content="How to securly access AWS ECR from GitHub Actions using GitHub OIDC"><meta property="og:description" content="How to securly access AWS ECR from GitHub Actions using GitHub OIDC"><meta property="og:type" content="article"><meta property="og:url" content="https://eelzinaty.github.io/ar/english/post/github-oidc-with-aws-orgnization/"><meta property="og:image" content="https://eelzinaty.github.io/images/site-feature-image.png"><meta property="article:section" content="english"><meta property="article:published_time" content="2022-07-31T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-31T00:00:00+00:00"><meta property="og:site_name" content="My learnings, Gray and Red!"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"english","name":"How to securly access AWS ECR from GitHub Actions using GitHub OIDC","headline":"How to securly access AWS ECR from GitHub Actions using GitHub OIDC","alternativeHeadline":"","description":"
      How to securly access AWS ECR from GitHub Actions using GitHub OIDC


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/eelzinaty.github.io\/ar\/english\/post\/github-oidc-with-aws-orgnization\/"},"author":{"@type":"Person","name":"Issam Alzinati"},"creator":{"@type":"Person","name":"Issam Alzinati"},"accountablePerson":{"@type":"Person","name":"Issam Alzinati"},"copyrightHolder":{"@type":"Person","name":"Issam Alzinati"},"copyrightYear":"2022","dateCreated":"2022-07-31T00:00:00.00Z","datePublished":"2022-07-31T00:00:00.00Z","dateModified":"2022-07-31T00:00:00.00Z","publisher":{"@type":"Organization","name":"Issam Alzinati","url":"https://eelzinaty.github.io","logo":{"@type":"ImageObject","url":"https:\/\/eelzinaty.github.io\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["https://eelzinaty.github.io/images/site-feature-image.png"],"url":"https:\/\/eelzinaty.github.io\/ar\/english\/post\/github-oidc-with-aws-orgnization\/","wordCount":"1320","genre":[],"keywords":["aws","aws iam","control tower","aws organization","github","github actions","ECR","OIDC"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.png alt="profile picture"><div class=sidebar__introduction-title><a href=/ar>My learnings, Gray and Red!</a></div><div class=sidebar__introduction-description><p>Learn by Doing<br>Help by Sharing</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/eelzinaty/ target=_blank rel=noopener aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/eelzinaty/ target=_blank rel=noopener aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:engessam1985@gmail.com target=_blank rel=noopener aria-label=e-mail title=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
Issam Alzinati
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.602bd2014468bd348112e2aa24f595c530d257a4ed6c335d7baaa6ac9a7ca6fb.js integrity="sha256-YCvSAURovTSBEuKqJPWVxTDSV6TtbDNde6qmrJp8pvs=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ar/ title>الرئيسية</a></li><li class=nav__list-item><a href=/ar/post/ title>المنشورات</a></li><li class=nav__list-item><a href=/ar/about/ title>حول</a></li><li class=nav__list-item><a href=/ar/contact/ title>للتواصل</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>How to Securly Access AWS ECR From GitHub Actions Using GitHub OIDC</h1><p>Companies are shifting from building monolith applications into more modular services where each service might represent a business context. They can even get into a more fine-grained breakdown and use a microservices approach to build their applications. Either way, this increases the use of containers. These containers are based on docker images that hold the application logic and dependencies. These images are built with every codebase pushed to the code repository and pushed to a container registry, so it can be later deployed to the corresponding container orchestrator.</p><p>I did some work where I were using GitHub to host the code, GitHub Actions for CI/CD, and AWS ECR as the container registry. I take security seriously and make sure I cover it in all aspects. One of the things I hate is long-living credentials. Using short-living credentials with GitHub Actions wasn’t doable till they announced the support of <a href=https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/>OpenID Connect in Oct 2021</a>.</p><p>As with any OIDC, to use it to access AWS resources you need to do the following:</p><ol><li>Create an OIDC provider entity in AWS IAM as an external identity provider (IdP).</li><li>Create IAM Role with a <code>Principle</code> that identifies the created OIDC and authenticates your GitHub repo.</li><li>Create IAM Policy that gives the needed permissions for the IAM Role.</li></ol><h2 id=define-github-oidc-and-iam-resources>Define GitHub OIDC and IAM Resources</h2><p>I&rsquo;m going to use CloudFormation to define the AWS resources.</p><h3 id=1-create-an-oidc-provider-entity-in-aws-iam-as-an-external-identity-provider-idp>1. Create an OIDC provider entity in AWS IAM as an external identity provider (IdP).</h3><p>AWS IAM service has a resource called <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html>OIDCProvider</a>. Also, CloudFormation <a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-oidcprovider.html>supports this resource</a>, Great! Now we need to get the GitHub OIDC information, The URL of the OIDC identity provider(idP), and a thumbprint of the idP certificate.
For the idP URL, you can find the information in <a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#adding-the-identity-provider-to-aws>GitHub Actions documentation</a>. The URL is <code>https://token.actions.githubusercontent.com</code>.
For the idP certificate thumbprint, <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc_verify-thumbprint.html>which is a signature for the CA&rsquo;s certificate that was used to issue the certificate for the OIDC-compatible idP</a>, you can obtain it using the following commands(<a href=https://stackoverflow.com/questions/69247498/how-can-i-calculate-the-thumbprint-of-an-openid-connect-server>long live stack overflow</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>% <span class=nv>HOST</span><span class=o>=</span><span class=k>$(</span>curl https://vstoken.actions.githubusercontent.com/.well-known/openid-configuration <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> jq -r <span class=s1>&#39;.jwks_uri | split(&#34;/&#34;)[2]&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>% <span class=nb>echo</span> <span class=p>|</span> openssl s_client -servername <span class=nv>$HOST</span> -showcerts -connect <span class=nv>$HOST</span>:443 2&gt; /dev/null <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> sed -n -e <span class=s1>&#39;/BEGIN/h&#39;</span> -e <span class=s1>&#39;/BEGIN/,/END/H&#39;</span> -e <span class=s1>&#39;$x&#39;</span> -e <span class=s1>&#39;$p&#39;</span> <span class=p>|</span> tail +2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> openssl x509 -fingerprint -noout <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> sed -e <span class=s2>&#34;s/.*=//&#34;</span> -e <span class=s2>&#34;s/://g&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> tr <span class=s2>&#34;ABCDEF&#34;</span> <span class=s2>&#34;abcdef&#34;</span>
</span></span><span class=line><span class=cl>6938fd4d98bab03faadb97b34396831e3780aea1
</span></span></code></pre></div><p>We got all the information we need, so here is the CloudFormation resource definition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>GithubOidc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::IAM::OIDCProvider&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://token.actions.githubusercontent.com&#39;</span><span class=w> </span><span class=c># GitHub OIDCProvider URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ClientIdList</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sts.amazonaws.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ThumbprintList</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>6938fd4d98bab03faadb97b34396831e3780aea1</span><span class=w> </span><span class=c># GitHub OIDCProvider thumbprint </span><span class=w>
</span></span></span></code></pre></div><h3 id=2-create-iam-role-with-a-principle-that-identifies-the-created-oidc-and-authenticates-your-github-repo>2. Create IAM Role with a <code>Principle</code> that identifies the created OIDC and authenticates your GitHub repo.</h3><p>For the IAM Role, it will be straightforward. We need to allow a principle(GitHub OIDC) to assume the IAM role and get <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_oidc.html>a WebIdentityToken</a>. Also, we will need to limit the permission to a specific GitHub organization.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Role</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::IAM::Role&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>RoleName</span><span class=p>:</span><span class=w> </span><span class=l>GithubOIDCIAMRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>AssumeRolePolicyDocument</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>Statement</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>Effect</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Action</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;sts:AssumeRoleWithWebIdentity&#39;</span><span class=w> </span><span class=c># Action to get a WebIdentityToken</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Principal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>Federated</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- !<span class=l>Ref GithubOidc</span><span class=w> </span><span class=c># AWS OIDCProvider resource created earlier</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>StringLike</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#39;token.actions.githubusercontent.com:sub&#39;</span><span class=p>:</span><span class=w> </span>!<span class=l>Sub &#39;repo:GitHubOrgName/*&#39;</span><span class=w> </span><span class=c># Allow any repo in under your GitHub Organization to assume this IAM Role</span><span class=w>
</span></span></span></code></pre></div><h3 id=3-create-iam-policy-that-gives-the-needed-permissions-for-the-iam-role>3. Create IAM Policy that gives the needed permissions for the IAM Role.</h3><p>Last part is to create an IAM policy that allows your GitHub Actions CI/CD to interact with AWS ECR.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::IAM::Policy&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>PolicyName</span><span class=p>:</span><span class=w> </span><span class=l>AllowPushImagesToECR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>PolicyDocument</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>Version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2012-10-17&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>Statement</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>Effect</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w> </span><span class=c># Retrieves an authorization token to login into ECR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Action</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ecr:GetAuthorizationToken&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Resource</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>Effect</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w> </span><span class=c># Get container image information from ECR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:GetDownloadUrlForLayer&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:BatchGetImage&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:BatchCheckLayerAvailability&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Resource</span><span class=p>:</span><span class=w> </span>!<span class=l>Sub &#39;arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>Effect</span><span class=p>:</span><span class=w> </span><span class=l>Allow</span><span class=w> </span><span class=c># upload container image to ECR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:CompleteLayerUpload&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:UploadLayerPart&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:InitiateLayerUpload&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=s1>&#39;ecr:PutImage&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>Resource</span><span class=p>:</span><span class=w> </span>!<span class=l>Sub &#39;arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- !<span class=l>Ref Role</span><span class=w> </span><span class=c># Reference to the AWS IAM role created in the previous step</span><span class=w>
</span></span></span></code></pre></div><p>This is the basic setup, <a href=https://gist.github.com/eelzinaty/ab5e1b8b4aa670f223ba8e6e4ed5927f>check the complete file</a>. Next I will show how to deploy and to use these resources with GitHub Actions.</p><h2 id=deploy-aws-resources-then-using-them-with-github-actions>Deploy AWS Resources then Using Them with GitHub Actions</h2><h3 id=deploy-cloudformation-stack-to-create-aws-resources>Deploy CloudFormation Stack to create AWS Resources</h3><p>This step can be done in different ways. The easiest one is to open the AWS Console and go to <a href="https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/template">CloudFormation Create Stack</a> and use the <code>Upload a template file</code> option. I&rsquo;m going to use the AWS CLI because it is better for automation if you want to! Here is the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ aws cloudformation deploy --template-file define_github_oidc_with_iam_role.yaml --stack-name github-oidc --parameter-overrides <span class=nv>GitHubOrg</span><span class=o>=</span>name-of-your-github-org
</span></span></code></pre></div><p>Here is <a href=https://gist.github.com/eelzinaty/ab5e1b8b4aa670f223ba8e6e4ed5927f>a link for the complete CloudFormation stack</a>.</p><p>You can verify the resources by visiting the IAM Console page and navigate to <a href="https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-east-1#/identity_providers">Identity Providers</a>. Then Check the <a href="https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-east-1#/roles">IAM Roles</a> and the <a href="https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-east-1#/policies">IAM Policies</a> for the new IAM Role and Policy we created via CloudFormation.</p><h3 id=set-up-the-github-actions-workflows-to-use-github-oidc-to-access-aws-resources>Set up the GitHub Actions Workflows to Use GitHub OIDC to Access AWS Resources.</h3><p>I prefer to use a parametrized GitHub workflows whenever it is possible. This helps me to abstract the workflow and use it with different repos without any changes. For that I use GitHub Actions secrets and configure the secrets across all the repos from the GitHub Organization settings. From settings navigate to <code>Security -> Secrets -> Actions</code>.</p><p><img src=/images/post/github-oidc-with-aws-orgnization/github-actions-secrets.png alt="GitHub Secrets for Actions"></p><p>Here are the secrets I usually add to all my workflows:</p><ol><li><code>AWS_DEFAULT_REGION</code>, this is the region where your workload is located. Example, <code>us-east-1</code>.</li><li><code>AWS_ACCOUNT_ID</code>, This is your AWS Account ID, <code>1234567890</code></li><li><code>AWS_ROLE_TO_PUSH_IMG</code>, This is the IAM Role name, <code>GithubOIDCIAMRole</code>.</li></ol><p>After setting the above secrets, we can build the GitHub Actions Workflow. As with any workflow, it consists of one job or more. In the job you are going to use to build and push your container image to ECR, you will need to define the following:</p><ol><li>For the job permissions, you need to add <code>id-token: write</code>. This permission is needed to interact with GitHub&rsquo;s OIDC Token endpoint.</li><li>You need a step to generate the AWS credentials.</li><li>You need a step to log in to the ECR repo</li><li>Toy need a step to build and push the container image to ECR.</li></ol><h4 id=1-define-the-workflow-and-add-the-job-permission>1. Define the workflow and add the job permission.</h4><p>Let&rsquo;s assume that this workflow will be triggered when the code is <code>merged</code> to the <code>main</code> branch. And it will have only one job, called <code>build-push-image</code>. Here is the skeleton of this workflow:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy 🚀</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>main</span><span class=w> </span><span class=c># Set a branch to deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build-push-image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># These permissions are needed to interact with GitHub&#39;s OIDC Token endpoint.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>permissions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>id-token</span><span class=p>:</span><span class=w> </span><span class=l>write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>contents</span><span class=p>:</span><span class=w> </span><span class=l>read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>actions</span><span class=p>:</span><span class=w> </span><span class=l>read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Here is where all the steps will be added</span><span class=w>
</span></span></span></code></pre></div><h4 id=2-generate-the-aws-credentials>2. Generate the AWS credentials</h4><p>This is where we are going to use AWS STS service to authenticate with GitHub OIDC to generate short living credentials for the IAM Role we created earlier. I will use <a href=https://github.com/aws-actions/configure-aws-credentials>the official AWS GitHub action</a>, <code>configure-aws-credentials</code>, to generate the credentials.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Configure AWS credentials</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>aws-actions/configure-aws-credentials@v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role-to-assume</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_ROLE_TO_PUSH_IMG }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>aws-region</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.AWS_DEFAULT_REGION }}</span><span class=w>
</span></span></span></code></pre></div><h4 id=3-log-in-to-the-ecr-repo>3. Log In to the ECR repo</h4><p>As with any remote and private container repo, you need to log in before you push an image. To do that, I&rsquo;m going to use <a href=https://github.com/aws-actions/amazon-ecr-login>the AWS official GitHub Action</a>,<code>amazon-ecr-login</code>, to log in to ECR.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Login to Amazon ECR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>login-ecr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>aws-actions/amazon-ecr-login@v1</span><span class=w>
</span></span></span></code></pre></div><h4 id=4-build-and-push-the-container-image>4. Build and Push the Container Image</h4><p>Finally, I will build and push the image using the regular docker commands, <code>build</code> and <code>push</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build, tag, and push image to Amazon ECR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ECR_REGISTRY</span><span class=p>:</span><span class=w> </span><span class=l>${{ steps.login-ecr.outputs.registry }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ECR_REPOSITORY</span><span class=p>:</span><span class=w> </span><span class=l>test-service</span><span class=w> </span><span class=c># the ECR repo name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>IMAGE_TAG: test # The image tag, it could be the commit SHA</span><span class=p>:</span><span class=w> </span><span class=l>${{ github.sha }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
</span></span></span><span class=line><span class=cl><span class=sd>    docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG</span><span class=w>    
</span></span></span></code></pre></div><p>And that was it! Now whenever a new code is pushed to the <code>main</code> branch a workflow will be triggered, short living token will be generated, and a container image will be built and deployed to ECR. <a href=https://gist.github.com/eelzinaty/4606aa792ada38f73209a220d68c0769>Here is a full version of the workflow file</a>.</p></div><div class=post__footer><span><a class=tag href=/ar/tags/aws/>aws</a><a class=tag href=/ar/tags/aws-iam/>aws iam</a><a class=tag href=/ar/tags/control-tower/>control tower</a><a class=tag href=/ar/tags/aws-organization/>aws organization</a><a class=tag href=/ar/tags/github/>github</a><a class=tag href=/ar/tags/github-actions/>github actions</a><a class=tag href=/ar/tags/ecr/>ECR</a><a class=tag href=/ar/tags/oidc/>OIDC</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
Issam Alzinati
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.602bd2014468bd348112e2aa24f595c530d257a4ed6c335d7baaa6ac9a7ca6fb.js integrity="sha256-YCvSAURovTSBEuKqJPWVxTDSV6TtbDNde6qmrJp8pvs=" crossorigin=anonymous></script></body></html>